<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Guías manuales</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body class="bg-slate-50 min-h-screen p-4 md:p-10">

    <div class="max-w-5xl mx-auto bg-white p-8 rounded-2xl shadow-xl border border-gray-100">
        <header class="text-center mb-10">
            <h1 class="text-3xl font-extrabold text-slate-800">Guías manuales</h1>
            <p class="text-slate-500 mt-2">Sube ambos archivos para cruzar Puntos y Destinos</p>
        </header>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-10">
            <div class="group border-2 border-dashed border-blue-300 p-6 rounded-xl bg-blue-50 hover:bg-blue-100 transition-colors">
                <div class="flex items-center mb-3">
                    <span class="bg-blue-500 text-white rounded-full h-8 w-8 flex items-center justify-center font-bold mr-3">1</span>
                    <h2 class="font-bold text-blue-800">Socios del Cliente</h2>
                </div>
                <p class="text-xs text-blue-600 mb-4 font-medium italic">Columnas requeridas: "código" y "nombre"</p>
                <input type="file" id="fileCliente" accept=".xlsx, .xls" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-blue-600 file:text-white hover:file:bg-blue-700 cursor-pointer"/>
            </div>

            <div class="group border-2 border-dashed border-emerald-300 p-6 rounded-xl bg-emerald-50 hover:bg-emerald-100 transition-colors">
                <div class="flex items-center mb-3">
                    <span class="bg-emerald-500 text-white rounded-full h-8 w-8 flex items-center justify-center font-bold mr-3">2</span>
                    <h2 class="font-bold text-emerald-800">Base de Datos Interna</h2>
                </div>
                <p class="text-xs text-emerald-600 mb-4 font-medium italic">Columnas: "código", "punto", "destino"</p>
                <input type="file" id="fileBase" accept=".xlsx, .xls" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-emerald-600 file:text-white hover:file:bg-emerald-700 cursor-pointer"/>
            </div>
        </div>

        <div class="flex flex-col sm:flex-row justify-center gap-4 mb-10">
            <button onclick="procesarArchivos()" class="bg-slate-800 hover:bg-slate-900 text-white font-bold py-3 px-10 rounded-xl transition shadow-lg transform hover:-translate-y-1">
                Procesar y Cruzar
            </button>
            
            <button id="btnDescargar" onclick="descargarExcel()" class="hidden bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-3 px-10 rounded-xl transition shadow-lg transform hover:-translate-y-1 flex items-center justify-center">
                <span>Descargar Resultados</span>
            </button>
        </div>

        <div id="resultado" class="hidden">
            <div class="flex justify-between items-center mb-4 border-b pb-2">
                <h2 class="text-xl font-bold text-slate-700">Vista Previa de Resultados</h2>
                <span id="contador" class="bg-slate-200 text-slate-700 text-xs font-bold px-3 py-1 rounded-full"></span>
            </div>
            <div class="overflow-x-auto rounded-lg border border-gray-200">
                <table class="min-w-full divide-y divide-gray-200" id="tablaResultados">
                    <thead class="bg-gray-100">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-bold text-gray-600 uppercase">Código</th>
                            <th class="px-6 py-3 text-left text-xs font-bold text-gray-600 uppercase">Nombre</th>
                            <th class="px-6 py-3 text-left text-xs font-bold text-gray-600 uppercase">Punto</th>
                            <th class="px-6 py-3 text-left text-xs font-bold text-gray-600 uppercase">Destino</th>
                        </tr>
                    </thead>
                    <tbody id="cuerpoTabla" class="bg-white divide-y divide-gray-200 text-sm text-gray-700">
                        </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        let dataCliente = [];
        let dataBase = [];
        let resultadoFinal = [];

        // Leer Archivo Cliente
        document.getElementById('fileCliente').addEventListener('change', (e) => leerExcel(e, (data) => dataCliente = data));
        
        // Leer Archivo Base
        document.getElementById('fileBase').addEventListener('change', (e) => leerExcel(e, (data) => dataBase = data));

        function leerExcel(e, callback) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (evt) => {
                const bstr = evt.target.result;
                const wb = XLSX.read(bstr, { type: 'binary' });
                const wsname = wb.SheetNames[0];
                const data = XLSX.utils.sheet_to_json(wb.Sheets[wsname]);
                callback(data);
            };
            reader.readAsBinaryString(file);
        }

        function procesarArchivos() {
            if (dataCliente.length === 0 || dataBase.length === 0) {
                alert("Por favor, asegúrate de haber cargado ambos archivos correctamente.");
                return;
            }

            const cuerpoTabla = document.getElementById('cuerpoTabla');
            cuerpoTabla.innerHTML = "";
            resultadoFinal = []; // Limpiar resultados anteriores

            dataCliente.forEach(socio => {
                // Normalización para evitar errores de mayúsculas/minúsculas
                const codigoSocio = String(socio.codigo || socio.Codigo || "").trim();
                
                const coincidencia = dataBase.find(item => 
                    String(item.codigo || item.Codigo || "").trim() === codigoSocio
                );

                const filaObj = {
                    "Código": codigoSocio,
                    "Nombre": socio.nombre || socio.Nombre || "N/A",
                    "Punto": coincidencia ? (coincidencia.punto || coincidencia.Punto) : "NO ENCONTRADO",
                    "Destino": coincidencia ? (coincidencia.destino || coincidencia.Destino) : "NO ENCONTRADO"
                };

                resultadoFinal.push(filaObj);

                // Crear fila visual
                const row = document.createElement('tr');
                row.className = coincidencia ? "hover:bg-gray-50" : "bg-red-50 hover:bg-red-100 text-red-700";
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap font-medium">${filaObj.Código}</td>
                    <td class="px-6 py-4 whitespace-nowrap">${filaObj.Nombre}</td>
                    <td class="px-6 py-4 whitespace-nowrap font-bold">${filaObj.Punto}</td>
                    <td class="px-6 py-4 whitespace-nowrap font-bold">${filaObj.Destino}</td>
                `;
                cuerpoTabla.appendChild(row);
            });

            document.getElementById('resultado').classList.remove('hidden');
            document.getElementById('btnDescargar').classList.remove('hidden');
            document.getElementById('contador').innerText = `${resultadoFinal.length} registros procesados`;
        }

        function descargarExcel() {
            if (resultadoFinal.length === 0) return;
            
            const ws = XLSX.utils.json_to_sheet(resultadoFinal);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Resultado Cruce");
            
            // Generar archivo y descargar
            XLSX.writeFile(wb, "Cruce_Socios_Final.xlsx");
        }
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gu√≠as de Transporte</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, sans-serif; margin: 0; background-color: #f0f2f5; color: #333; }
        .no-print { padding: 20px; max-width: 1200px; margin: auto; }
        .container { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        h2 { color: #2c3e50; border-bottom: 2px solid #3498db; padding-bottom: 10px; }
        .flex-container { display: flex; gap: 20px; margin-bottom: 20px; }
        .box { flex: 1; display: flex; flex-direction: column; }
        label { font-weight: bold; margin-bottom: 8px; }
        textarea { width: 100%; height: 150px; border: 2px solid #dee2e6; border-radius: 6px; padding: 12px; resize: vertical; }
        #inputEscaneo { background-color: #e8f0fe; border-color: #3498db; }
        .file-input-container { margin-bottom: 20px; padding: 15px; background: #f8f9fa; border: 2px dashed #3498db; border-radius: 6px; }
        .button-group { display: flex; gap: 10px; margin-bottom: 20px; align-items: center; flex-wrap: wrap; }
        .btn { padding: 12px 20px; border-radius: 4px; cursor: pointer; font-size: 14px; font-weight: bold; border: none; color: white; transition: 0.3s; }
        .btn-procesar { background-color: #2ecc71; }
        .btn-imprimir { background-color: #9b59b6; }
        .btn-limpiar { background-color: #e74c3c; }
        .stats { font-size: 1.1em; font-weight: bold; margin-left: auto; }
        .counter { background: #3498db; color: white; padding: 2px 8px; border-radius: 5px; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 13px; }
        th, td { border: 1px solid #e0e0e0; padding: 10px; text-align: left; }
        th { background-color: #f8f9fa; }
        .row-found { background-color: #d4edda; }
        .row-pending { background-color: #fff3cd; }

        /* Estilos de Etiquetas */
        @page { size: 4in 6in; margin: 0; }
        #seccionImpresion { display: none; }
        .etiqueta {
            width: 4in; height: 6in; margin: 15px auto; background: white;
            display: flex; flex-direction: column; justify-content: center;
            align-items: center; text-align: center; box-sizing: border-box;
            page-break-after: always; padding: 0.3in; border: 1px solid #ddd;
        }
        .et-header { font-size: 28pt; font-weight: bold; font-style: italic; text-decoration: underline; text-transform: uppercase; margin-bottom: 0.2in; width: 100%; }
        .et-location { font-size: 24pt; margin-bottom: 0.1in; text-transform: uppercase; }
        .et-name-container { width: 100%; height: 1.3in; display: flex; align-items: center; justify-content: center; }
        .et-name { font-size: 26pt; font-weight: bold; text-transform: uppercase; line-height: 1.1; }
        .et-details { font-size: 22pt; line-height: 1.4; border-top: 3px solid #000; padding-top: 0.15in; width: 95%; }

        @media print {
            .no-print { display: none !important; }
            #seccionImpresion { display: block !important; }
            .etiqueta { margin: 0; border: none; }
        }
    </style>
</head>
<body>

<div class="no-print">
    <div class="container">
        <h2>üßæ GESTI√ìN DE TRANSPORTE</h2>
        
        <div class="file-input-container">
            <label>1. Cargar base de c√©dula y tel√©fono</label><br>
            <input type="file" id="excelSocios" accept=".xlsx, .xls">
            <p style="font-size: 0.85em; color: #666; margin-top: 5px;">
                Aseg√∫rate de que las columnas se llamen: <b>Codigo</b>, <b>Cedula</b> y <b>Telefono</b>.
            </p>
        </div>

        <div class="flex-container">
            <div class="box">
                <label>2. Pistolea Pedidos:</label>
                <textarea id="inputEscaneo" placeholder="Escanea c√≥digos aqu√≠..."></textarea>
            </div>
            <div class="box">
                <label>3. Pega Data Orisales:</label>
                <textarea id="rawData" placeholder="Pega aqu√≠ la tabla de Orisales..."></textarea>
            </div>
        </div>
        
        <div class="button-group">
            <button class="btn btn-procesar" onclick="procesarInformacion()">Procesar y Vincular</button>
            <button class="btn btn-imprimir" id="btnGenerarEtiquetas" onclick="generarVistaEtiquetas()" style="display:none;">Imprimir Etiquetas</button>
            <button class="btn btn-limpiar" onclick="location.reload()">Limpiar Todo</button>
            
            <div class="stats" id="statsArea" style="display:none;">
                Vinculados: <span id="cantEncontrados" class="counter">0</span> de <span id="cantTotal" class="counter">0</span>
            </div>
        </div>

        <table id="tablaResultados">
            <thead>
                <tr>
                    <th>Pedido</th>
                    <th>Cooperativa</th> 
                    <th>Destino</th>
                    <th>Nombre del Socio</th>
                    <th>C√©dula</th>
                    <th>Tel√©fono</th>
                </tr>
            </thead>
            <tbody id="cuerpoTabla"></tbody>
        </table>
    </div>
</div>

<div id="seccionImpresion"></div>

<script>
    let dbSocios = new Map();
    let datosFinales = [];

    // Funci√≥n para normalizar nombres de columnas (quitar espacios, acentos y pasar a min√∫sculas)
    function normalizar(texto) {
        return String(texto).toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").trim();
    }

    document.getElementById('excelSocios').addEventListener('change', function(e) {
        const reader = new FileReader();
        reader.onload = function(e) {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, {type: 'array'});
            const sheet = workbook.Sheets[workbook.SheetNames[0]];
            const jsonData = XLSX.utils.sheet_to_json(sheet);
            
            dbSocios.clear();
            jsonData.forEach(fila => {
                // Buscamos las columnas sin importar c√≥mo est√©n escritas
                let colCodigo, colCedula, colTelefono;
                
                for (let key in fila) {
                    let keyNorm = normalizar(key);
                    if (keyNorm === "codigo" || keyNorm === "cod") colCodigo = fila[key];
                    if (keyNorm === "cedula" || keyNorm === "ci" || keyNorm === "identificacion") colCedula = fila[key];
                    if (keyNorm === "telefono" || keyNorm === "tel" || keyNorm === "celular") colTelefono = fila[key];
                }

                if (colCodigo) {
                    dbSocios.set(String(colCodigo).trim(), {
                        cedula: colCedula || "No registra",
                        telefono: colTelefono || "No registra"
                    });
                }
            });
            alert("‚úì Base de datos vinculada (" + dbSocios.size + " socios cargados)");
        };
        reader.readAsArrayBuffer(e.target.files[0]);
    });

    function obtenerInfoTransporte(texto) {
        let info = { transporte: "N/A", destino: "N/A" };
        if (!texto || texto === "N/A") return info;
        let partes = texto.split("-").map(p => p.trim()).filter(p => p !== "" && !/^\d+$/.test(p));
        if (partes.length >= 2) {
            let idx = partes.findIndex(p => p.toUpperCase().includes("TRANSPORTE"));
            if (idx !== -1) {
                info.transporte = partes[idx];
                partes.splice(idx, 1);
                info.destino = partes.join(" ");
            } else {
                info.transporte = partes[partes.length - 1];
                info.destino = partes[0];
            }
        } else if (partes.length === 1) { info.transporte = partes[0]; }
        return info;
    }

    function procesarInformacion() {
        const escaneo = document.getElementById('inputEscaneo').value.trim().split("\n");
        const orisalesRaw = document.getElementById('rawData').value.trim();
        const cuerpo = document.getElementById('cuerpoTabla');
        
        const orisalesMap = new Map();
        orisalesRaw.split("\n").forEach(fila => {
            const col = fila.split("\t");
            if (col.length >= 20) {
                orisalesMap.set(col[3]?.trim(), {
                    socioId: col[13]?.trim(),
                    nombre: col[14]?.trim(),
                    trans: col[20]?.trim()
                });
            }
        });

        cuerpo.innerHTML = "";
        datosFinales = [];
        let encontrados = 0;

        escaneo.forEach(pedido => {
            const p = pedido.trim();
            if (!p) return;
            const dataOrisales = orisalesMap.get(p);
            const tr = document.createElement('tr');

            if (dataOrisales) {
                encontrados++;
                // Vinculaci√≥n clave: buscamos el ID del socio en el mapa del Excel
                const extra = dbSocios.get(dataOrisales.socioId) || { cedula: "PENDIENTE", telefono: "PENDIENTE" };
                const tInfo = obtenerInfoTransporte(dataOrisales.trans);
                
                const item = {
                    pedido: p,
                    cooperativa: tInfo.transporte,
                    destino: tInfo.destino,
                    nombre: dataOrisales.nombre,
                    cedula: extra.cedula,
                    telefono: extra.telefono
                };
                datosFinales.push(item);

                tr.className = "row-found";
                tr.innerHTML = `<td>${item.pedido}</td><td>${item.cooperativa}</td><td>${item.destino}</td><td>${item.nombre}</td><td>${item.cedula}</td><td>${item.telefono}</td>`;
            } else {
                tr.className = "row-pending";
                tr.innerHTML = `<td>${p}</td><td colspan="5">No encontrado en Orisales</td>`;
            }
            cuerpo.appendChild(tr);
        });

        document.getElementById('statsArea').style.display = "block";
        document.getElementById('cantTotal').innerText = escaneo.filter(x => x.trim()).length;
        document.getElementById('cantEncontrados').innerText = encontrados;
        document.getElementById('btnGenerarEtiquetas').style.display = encontrados > 0 ? "inline-block" : "none";
    }

    function generarVistaEtiquetas() {
        const cont = document.getElementById('seccionImpresion');
        cont.innerHTML = "";
        datosFinales.forEach(d => {
            const div = document.createElement('div');
            div.className = 'etiqueta';
            div.innerHTML = `
                <div class="et-header">${d.cooperativa}</div>
                <div class="et-location">${d.destino}</div>
                <div class="et-name-container"><div class="et-name">${d.nombre}</div></div>
                <div class="et-details">CI: ${d.cedula}<br>TEL: ${d.telefono}</div>
            `;
            cont.appendChild(div);
        });
        setTimeout(() => { 
            // Ajuste de texto para nombres largos
            document.querySelectorAll('.et-name').forEach(el => {
                let fs = 26;
                while (el.scrollHeight > el.parentElement.clientHeight && fs > 10) {
                    fs--; el.style.fontSize = fs + 'pt';
                }
            });
            window.print(); 
        }, 300);
    }
</script>
</body>
</html>
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Control de registros Maquila</title>
  
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>

  <style>
    body { font-family: Arial, sans-serif; background: #f4f6f8; padding: 20px; }
    .card { max-width: 1000px; margin: auto; background: #fff; padding: 20px; border-radius: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
    h1 { text-align: center; margin-bottom: 5px; }
    
    #reloj {
        text-align: center; font-size: 18px; color: #1565c0; font-weight: bold;
        margin-bottom: 20px; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    .row { display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap; align-items: center; }
    input, select { flex: 1; padding: 10px; font-size: 16px; border: 1px solid #ccc; border-radius: 4px; }
    button { padding: 10px 15px; font-size: 16px; border: none; border-radius: 6px; cursor: pointer; transition: 0.3s; }
    button:hover { opacity: 0.8; }
    .in { background: #4CAF50; color: #fff; }
    .out { background: #f44336; color: #fff; }
    .xls { background: #1976d2; color: #fff; width: 100%; margin-bottom: 5px; }
    .clear { background: #757575; color: #fff; width: 100%; }
    
    table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 14px; }
    th, td { border: 1px solid #ddd; padding: 8px; text-align: center; }
    th { background: #f0f0f0; }
    
    .status-msg { font-size: 12px; color: green; margin-top: 5px; display: none; }
    .pendiente { color: #d32f2f; font-style: italic; font-weight: bold; }
    .completado { color: #388e3c; font-weight: bold; }

    .contador-container {
      margin-left: auto; background: #333; color: #fff; padding: 8px 15px;
      border-radius: 5px; font-weight: bold; font-size: 14px; min-width: 120px; text-align: center;
    }
    #num-contador { font-size: 18px; color: #ffeb3b; margin-left: 5px; }
    
    /* Indicador de conexión */
    #db-status { text-align: center; font-size: 12px; margin-bottom: 10px; color: #666; }
    .online { color: green; font-weight: bold; }
    .offline { color: red; font-weight: bold; }
  </style>
</head>
<body>

  <audio id="snd-notif" src="https://assets.mixkit.co/active_storage/sfx/2358/2358-preview.mp3"></audio>

  <div class="card">
    <h1>Control de asistencia Maquila</h1>
    <div id="db-status">Iniciando sistema...</div>
    
    <div id="reloj">--:--:--</div>

    <p style="font-size: 14px; color: #555;">Suba la base de empleados (Solo es necesario hacerlo una vez o al actualizar personal).</p>
    <input type="file" id="archivoExcel" accept=".xlsx,.xls" />
    <div id="msgCargado" class="status-msg">✓ Lista de empleados disponible</div>

    <div class="row" style="margin-top: 15px;">
      <input type="text" id="cedula" placeholder="Ingrese número de cédula" autofocus />
      <input type="text" id="nombre" placeholder="Nombre del empleado" readonly />
      <select id="procedencia">
        <option value="" disabled selected>Seleccione Maquila (Solo Ingreso)</option>
        <option value="Dprisa">Dprisa</option>
        <option value="Seripro">Seripro</option>
      </select>
    </div>

    <div class="row">
      <button class="in" onclick="registrar('Ingreso')">Registrar Ingreso</button>
      <button class="out" onclick="registrar('Salida')">Registrar Salida</button>
      <div class="contador-container">
        Ingresados hoy: <span id="num-contador">0</span>
      </div>
    </div>

    <button class="xls" onclick="descargarExcel()">Descargar reporte</button>
    <button class="clear" onclick="limpiarRegistros()">Limpiar historial</button>

    <table id="tabla">
      <thead>
        <tr>
          <th>Cédula</th>
          <th>Nombre</th>
          <th>Maquila</th>
          <th>Fecha</th>
          <th>Ingreso</th>
          <th>Salida</th>
          <th>Tiempo Laborado</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <script>
    // --- 1. TU CONFIGURACIÓN DE FIREBASE ---
    const firebaseConfig = {
      apiKey: "AIzaSyA3pJXgmnpeTOH4OG9EV_oPMg-Ga5tnRdc",
      authDomain: "controlmaquila.firebaseapp.com",
      databaseURL: "https://controlmaquila-default-rtdb.firebaseio.com",
      projectId: "controlmaquila",
      storageBucket: "controlmaquila.firebasestorage.app",
      messagingSenderId: "201607113758",
      appId: "1:201607113758:web:d286dcbcb04a0bcee6520f"
    };

    // Inicializar Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    
    const refEmpleados = db.ref('empleados');
    const refRegistros = db.ref('registros');

    let empleadosLocal = {};
    let registrosLocal = [];
    const sound = document.getElementById('snd-notif');

    // --- 2. MONITOREO DE CONEXIÓN Y DATOS ---
    
    // Estado de conexión
    db.ref('.info/connected').on('value', function(snap) {
      const statusEl = document.getElementById('db-status');
      if (snap.val() === true) {
        statusEl.innerHTML = 'Estado: <span class="online">● Conectado a la Nube</span>';
      } else {
        statusEl.innerHTML = 'Estado: <span class="offline">○ Desconectado (Revisar internet)</span>';
      }
    });

    // Escuchar cambios en Empleados (Carga automática)
    refEmpleados.on('value', (snapshot) => {
        const data = snapshot.val();
        if (data) {
            empleadosLocal = data;
            document.getElementById('msgCargado').style.display = 'block';
            document.getElementById('msgCargado').innerText = "✓ Lista de empleados sincronizada (" + Object.keys(data).length + ") personas";
        } else {
            empleadosLocal = {};
        }
    });

    // Escuchar cambios en Registros (Actualización en tiempo real)
    refRegistros.on('value', (snapshot) => {
        const data = snapshot.val();
        registrosLocal = [];
        
        if (data) {
            // Convertir objeto de Firebase a Array
            Object.keys(data).forEach(key => {
                registrosLocal.push({
                    idFirebase: key,
                    ...data[key]
                });
            });
        }
        renderizarTabla();
        actualizarContador();
    });

    // --- 3. RELOJ ---
    function actualizarReloj() {
        const ahora = new Date();
        const opciones = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit', second: '2-digit' };
        let fechaTexto = ahora.toLocaleDateString('es-ES', opciones);
        fechaTexto = fechaTexto.charAt(0).toUpperCase() + fechaTexto.slice(1);
        document.getElementById('reloj').innerText = fechaTexto;
    }
    setInterval(actualizarReloj, 1000);
    actualizarReloj();

    // --- 4. SUBIDA DE EXCEL (EMPLEADOS) ---
    document.getElementById('archivoExcel').addEventListener('change', function(e) {
      const reader = new FileReader();
      reader.onload = (evt) => {
        const data = new Uint8Array(evt.target.result);
        const workbook = XLSX.read(data, { type: 'array' });
        const json = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
        
        let nuevosEmpleados = {};
        json.forEach(row => {
            if(row.Cedula) nuevosEmpleados[row.Cedula.toString().trim()] = row.Nombre;
        });

        // Guardar en la nube
        refEmpleados.set(nuevosEmpleados)
            .then(() => alert('Base de empleados actualizada en la nube correctamente.'))
            .catch(err => alert('Error al subir: ' + err.message));
      };
      reader.readAsArrayBuffer(e.target.files[0]);
    });

    // Autocompletar nombre al escribir cédula
    document.getElementById('cedula').addEventListener('input', function() {
      const val = this.value.trim();
      document.getElementById('nombre').value = empleadosLocal[val] || '';
    });

    // --- 5. LÓGICA DE REGISTRO ---
    function actualizarContador() {
        const fechaHoy = new Date().toLocaleDateString();
        const totalHoy = registrosLocal.filter(r => r.fecha === fechaHoy).length;
        document.getElementById('num-contador').innerText = totalHoy;
    }

    function registrar(accion) {
      const cedula = document.getElementById('cedula').value.trim();
      const nombre = document.getElementById('nombre').value.trim();
      const procedenciaSeleccionada = document.getElementById('procedencia').value;
      
      const ahora = new Date();
      const fechaHoy = ahora.toLocaleDateString();
      const horaActualStr = ahora.toLocaleTimeString();

      if (!cedula) {
        alert('Ingrese una cédula'); return;
      }
      if (!nombre) {
        sound.play(); alert('Empleado no encontrado en la base de datos.'); return;
      }

      // Buscar registro existente HOY
      const registroExistente = registrosLocal.find(r => r.cedula === cedula && r.fecha === fechaHoy);

      if (accion === 'Ingreso') {
          if (!procedenciaSeleccionada) {
              sound.play(); alert('Seleccione procedencia (Maquila).'); return;
          }

          if (registroExistente) {
              sound.play(); alert('Error: Ya tiene INGRESO registrado hoy.'); return;
          }

          const nuevoRegistro = {
              cedula,
              nombre,
              procedencia: procedenciaSeleccionada,
              fecha: fechaHoy,
              horaIngreso: horaActualStr,
              horaSalida: 'Pendiente',
              tiempoLaborado: 'En curso',
              timestampIngreso: ahora.getTime()
          };
          
          // Enviar a Firebase
          refRegistros.push(nuevoRegistro).catch(err => alert("Error de red: " + err.message));

      } else if (accion === 'Salida') {
          if (!registroExistente) {
              sound.play(); alert('Error: No tiene registro de entrada hoy.'); return;
          }

          if (registroExistente.horaSalida !== 'Pendiente') {
              sound.play(); alert('Error: Ya marcó SALIDA hoy.'); return;
          }

          const msIngreso = registroExistente.timestampIngreso;
          const diffMs = ahora.getTime() - msIngreso;
          const diffHrs = Math.floor(diffMs / 3600000);
          const diffMins = Math.floor((diffMs % 3600000) / 60000);
          
          // Actualizar en Firebase
          db.ref('registros/' + registroExistente.idFirebase).update({
              horaSalida: horaActualStr,
              tiempoLaborado: `${diffHrs}h ${diffMins}m`
          }).catch(err => alert("Error de red: " + err.message));
      }

      sound.play();
      
      // Limpiar campos
      document.getElementById('cedula').value = '';
      document.getElementById('nombre').value = '';
      document.getElementById('procedencia').value = '';
      document.getElementById('cedula').focus();
    }

    function renderizarTabla() {
        const tbody = document.querySelector('#tabla tbody');
        tbody.innerHTML = registrosLocal.slice().reverse().map(reg => {
            const claseSalida = reg.horaSalida === 'Pendiente' ? 'pendiente' : 'completado';
            return `
            <tr>
                <td>${reg.cedula}</td>
                <td>${reg.nombre}</td>
                <td>${reg.procedencia}</td>
                <td>${reg.fecha}</td>
                <td style="color:green; font-weight:bold;">${reg.horaIngreso}</td>
                <td class="${claseSalida}">${reg.horaSalida}</td>
                <td style="font-weight:bold;">${reg.tiempoLaborado}</td>
            </tr>
        `}).join('');
    }

    function descargarExcel() {
      // Filtrar datos para que no salga el ID interno de firebase
      const datosParaExcel = registrosLocal.map(({idFirebase, timestampIngreso, ...resto}) => resto);
      
      const ws = XLSX.utils.json_to_sheet(datosParaExcel);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Asistencia");
      XLSX.writeFile(wb, 'reporte_maquila_online.xlsx');
    }

    function limpiarRegistros() {
        if (confirm('⚠️ PELIGRO: Esto borrará el historial de la NUBE para TODOS.\n¿Continuar?')) {
            refRegistros.remove();
        }
    }
  </script>
</body>
</html>